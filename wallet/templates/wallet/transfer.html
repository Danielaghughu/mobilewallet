{% extends 'wallet/base.html' %}
{% block content %}

<form method="POST" class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-md space-y-4">
    {% csrf_token %}
    
    <h2 class="text-xl font-semibold text-gray-800 mb-2">Make a Transfer</h2>

    <!-- Account Number -->
    <div>
        <label for="sender" class="block text-sm font-medium text-gray-700 mb-1">Account Number</label>
        <input 
            type="text" 
            name="sender" 
            id="sender" 
            placeholder="Enter account number" 
            class="w-full border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none"
            required>
    </div>

    <!-- Bank Selection -->
    <div>
        <label for="bank" class="block text-sm font-medium text-gray-700 mb-1">Select Bank</label>
        <select 
            name="bank" 
            id="bank" 
            class="w-full border border-gray-300 rounded-md p-3 bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none"
            required>
            <option value="" disabled selected>Loading banks...</option>
        </select>
    </div>

    <!-- Account Name (Auto-loaded) -->
    <div>
        <label for="account_name" class="block text-sm font-medium text-gray-700 mb-1">Account Name</label>
        <input 
            type="text" 
            name="account_name" 
            id="account_name" 
            readonly
            placeholder="Account name will appear here" 
            class="w-full bg-gray-100 border border-gray-300 rounded-md p-3 text-gray-700 focus:outline-none">
    </div>

    <!-- Amount -->
    <div>
        <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
        <input 
            type="number" 
            step="0.01" 
            name="amount" 
            id="amount" 
            placeholder="â‚¦0.00" 
            class="w-full border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none"
            required>
    </div>

    <!-- Submit Button -->
    <button 
        type="submit" 
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-md transition duration-300">
        Transfer
    </button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        getBanks();

        const senderInput = document.getElementById('sender');
        const bankSelect = document.getElementById('bank');

        senderInput.addEventListener('input', tryVerify);
        bankSelect.addEventListener('change', tryVerify);
    });

    function tryVerify() {
        const bankCode = document.getElementById('bank').value;
        const accountNumber = document.getElementById('sender').value;

        if (bankCode && accountNumber.length === 10) {
            verifyAccount(bankCode, accountNumber);
        } else {
            document.getElementById('account_name').value = '';
        }
    }

    async function getBanks() {
        try {
            const response = await fetch('https://api.paystack.co/bank', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer {{ paystack_public_key }}',
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) throw new Error('Failed to fetch banks');

            const data = await response.json();
            const bankSelect = document.getElementById('bank');
            bankSelect.innerHTML = '<option value="" disabled selected>Select bank</option>';

            data.data.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank.code;
                option.textContent = bank.name;
                bankSelect.appendChild(option);
            });

        } catch (error) {
            console.error('Error fetching banks:', error);
            alert('Unable to load banks. Please try again later.');
        }
    }

    async function verifyAccount(bankCode, accountNumber) {
        try {
            const response = await fetch(`/verify-account/?account_number=${accountNumber}&bank_code=${bankCode}`);
            if (!response.ok) throw new Error('Network error');

            const data = await response.json();

            if (data.status && data.data) {
                document.getElementById('account_name').value = data.data.account_name;
            } else {
                document.getElementById('account_name').value = 'Account not found';
            }

        } catch (error) {
            console.error('Verification error:', error);
            document.getElementById('account_name').value = 'Verification failed';
        }
    }
</script>

{% endblock %}
